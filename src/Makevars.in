## ---- fastgeojson: src/Makevars.in ----
## Build Rust staticlib (via cargo) and link into the R shared library.

TARGET_DIR := rust/target
LIBDIR     := $(TARGET_DIR)/release
STATLIB    := $(LIBDIR)/libfastgeojson.a

UNAME_S    := $(shell uname -s)

## Base link flags: link against the Rust staticlib we build below
PKG_LIBS   := -L$(LIBDIR) -lfastgeojson

## macOS: dead_strip helps the linker drop unused runtime bits (often reduces "abort" symbol noise)
ifeq ($(UNAME_S),Darwin)
PKG_LIBS   := $(PKG_LIBS) -Wl,-dead_strip
endif

all: $(SHLIB)

## Ensure the Rust archive exists before linking the shared library
$(SHLIB): $(STATLIB)

## ---- Build Rust staticlib ----
## IMPORTANT: the command lines below MUST start with a real TAB character.
$(STATLIB):
	@echo "== fastgeojson: Rust toolchain =="
	rustc --version
	cargo --version
	@echo "== fastgeojson: setup vendored deps =="
	mkdir -p rust/.cargo
	if [ -f rust/vendor.tar.xz ]; then \
		tar xf rust/vendor.tar.xz -C rust && \
		echo '[source.crates-io]' > rust/.cargo/config.toml && \
		echo 'replace-with = "vendored-sources"' >> rust/.cargo/config.toml && \
		echo '[source.vendored-sources]' >> rust/.cargo/config.toml && \
		echo 'directory = "vendor"' >> rust/.cargo/config.toml; \
	fi
	@echo "== fastgeojson: build Rust =="
	export CARGO_HOME="$(CURDIR)/rust/.cargo" && \
	if [ -f rust/vendor.tar.xz ]; then \
		echo "Building OFFLINE..." && \
		cargo build --release --lib --offline \
			--manifest-path=rust/Cargo.toml \
			--target-dir $(TARGET_DIR); \
	else \
		echo "Building ONLINE..." && \
		cargo build --release --lib \
			--manifest-path=rust/Cargo.toml \
			--target-dir $(TARGET_DIR); \
	fi

clean:
	rm -f $(SHLIB) $(OBJECTS)
	rm -rf $(TARGET_DIR) rust/.cargo rust/vendor
