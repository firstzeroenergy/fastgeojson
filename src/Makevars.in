## ---- fastgeojson: src/Makevars.in (portable) ----
## DO NOT use GNU make extensions here.

TARGET_DIR = rust/target
LIBDIR     = $(TARGET_DIR)/release
STATLIB    = $(LIBDIR)/libfastgeojson.a

## PKG_LIBS gets the platform-specific extra flags via configure substitution
PKG_LIBS   = -L$(LIBDIR) -lfastgeojson @DARWIN_LDFLAGS@

all: $(SHLIB)

## Ensure Rust static library exists before linking
$(SHLIB): $(STATLIB)

$(STATLIB):
	@echo "== fastgeojson: Rust toolchain =="
	rustc --version
	cargo --version

	@echo "== fastgeojson: setup vendored deps =="
	mkdir -p rust/.cargo
	if [ -f rust/vendor.tar.xz ]; then \
		tar xf rust/vendor.tar.xz -C rust && \
		echo '[source.crates-io]' > rust/.cargo/config.toml && \
		echo 'replace-with = "vendored-sources"' >> rust/.cargo/config.toml && \
		echo '[source.vendored-sources]' >> rust/.cargo/config.toml && \
		echo 'directory = "vendor"' >> rust/.cargo/config.toml; \
	fi

	@echo "== fastgeojson: build Rust =="
	CARGO_HOME="`pwd`/rust/.cargo"; export CARGO_HOME; \
	if [ -f rust/vendor.tar.xz ]; then \
		echo "Building OFFLINE."; \
		cargo build --release --lib --offline \
			--manifest-path=rust/Cargo.toml \
			--target-dir $(TARGET_DIR); \
	else \
		echo "Building ONLINE."; \
		cargo build --release --lib \
			--manifest-path=rust/Cargo.toml \
			--target-dir $(TARGET_DIR); \
	fi

clean:
	rm -f $(SHLIB) $(OBJECTS)
	rm -rf $(TARGET_DIR) rust/.cargo rust/vendor
