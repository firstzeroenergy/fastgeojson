name: R-CMD-check

on:
  push:
  pull_request:

jobs:
  R-CMD-check:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: release

      - name: Set up Pandoc
        uses: r-lib/actions/setup-pandoc@v2

      # REQUIRED: fixes pdflatex ERROR
      - name: Install TinyTeX (PDF manual)
        uses: r-lib/actions/setup-tinytex@v2

      - name: Install system dependencies
        run: |
          brew update
          brew install pkg-config

      - name: Install R package dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: any::rcmdcheck
          needs: check

      # CRAN-style workflow: build first
      - name: Build source tarball
        run: |
          R CMD build .

      # CRAN-style check on tarball
      - name: Run R CMD check (as CRAN)
        env:
          _R_CHECK_CRAN_INCOMING_: false
        run: |
          R CMD check --as-cran fastgeojson_*.tar.gz

      # ✅ KEEP THIS — diagnostic only
      - name: Diagnose _abort symbol provenance (macOS only)
        if: runner.os == 'macOS'
        run: |
          set -euxo pipefail

          echo "== Locate built shared object fastgeojson.so =="
          find . -path '*fastgeojson.Rcheck*' -path '*libs*' -name 'fastgeojson.so' -print || true

          SO="$(find . -path '*fastgeojson.Rcheck*' -path '*libs*' -name 'fastgeojson.so' | head -n 1 || true)"
          echo "SO=$SO"

          if [ -n "$SO" ]; then
            echo "== nm -a (show abort-related symbols) =="
            nm -a "$SO" | grep -E '(_abort|abort_internal|process5abort|compilerrt_abort|___compilerrt_abort_impl)' || true

            echo "== otool -Iv (imported symbols only, abort-related) =="
            otool -Iv "$SO" | grep -E '(_abort|compilerrt_abort|___compilerrt_abort_impl)' || true

            echo "== Confirm whether _abort is imported (U) =="
            nm -a "$SO" | grep -E ' U _abort' || true
          fi

          echo "== Locate Rust static archive libfastgeojson.a inside check tree =="
          A="$(find . -path '*fastgeojson.Rcheck*' -name 'libfastgeojson.a' | head -n 1 || true)"
          echo "A=$A"

          if [ -n "$A" ]; then
            echo "== Archive members (first 50) =="
            ar -t "$A" | head -n 50 || true

            echo "== Extract archive and find first object referencing U _abort =="
            WORK="/tmp/arobjs"
            rm -rf "$WORK"
            mkdir -p "$WORK"
            cd "$WORK"
            ar -x "$A"

            FOUND=""
            for o in *.o; do
              if nm -a "$o" | grep -q ' U _abort'; then
                FOUND="$o"
                break
              fi
            done

            echo "FOUND_OBJECT=$FOUND"
            if [ -n "$FOUND" ]; then
              echo "== nm -a on offending object (abort-related lines) =="
              nm -a "$FOUND" | grep -E '(_abort|abort_internal|process5abort|compilerrt_abort|___compilerrt_abort_impl)' || true

              echo "== file type (sometimes reveals compiler_builtins vs std) =="
              file "$FOUND" || true
            else
              echo "No object in libfastgeojson.a directly shows ' U _abort' (it may be pulled in later at final link)."
            fi
          fi

      - name: Upload check results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macOS-check-results
          path: |
            fastgeojson.Rcheck
            *.Rcheck